<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Bank Payment Portal</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body style="font-family: Arial; background-color: #f6f8fa; padding: 40px;">

<h2>üí∞ Add Funds to Your Account</h2>

<form id="payment-form">
    <label for="amount">Enter Amount (INR):</label>
    <input type="number" id="amount" min="1" required>
    <button type="submit" style="margin-left: 10px;">Pay Now</button>
</form>

<hr>

<div id="payment-status" style="margin-top: 20px; font-weight: bold;"></div>

<script>
document.getElementById("payment-form").addEventListener("submit", async function(e) {
    e.preventDefault();

    const amount = document.getElementById("amount").value;

    // Step 1Ô∏è‚É£ Create order from backend
    const createRes = await fetch(`/api/payments/create?amount=${amount}`, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + localStorage.getItem("jwtToken"),
        }
    });
    const order = await createRes.json();

    const options = {
        "key": order.key,
        "amount": order.amount * 100,
        "currency": order.currency,
        "name": "Bank of Zulkar",
        "description": "Add Money to Your Account",
        "order_id": order.orderId,
        "handler": async function (response) {
            // Step 2Ô∏è‚É£ Verify payment
            const verifyBody = {
                orderId: order.orderId,
                paymentId: response.razorpay_payment_id,
                signature: response.razorpay_signature
            };

            const verifyRes = await fetch(`/api/payments/verify`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + localStorage.getItem("jwtToken"),
                },
                body: JSON.stringify(verifyBody)
            });

            if (verifyRes.ok) {
                document.getElementById("payment-status").innerHTML = 
                    "‚úÖ Payment Successful! Funds credited to your account.";
            } else {
                document.getElementById("payment-status").innerHTML = 
                    "‚ùå Payment verification failed.";
            }
        },
        "theme": {
            "color": "#3399cc"
        }
    };

    const rzp = new Razorpay(options);
    rzp.open();
});
</script>
</body>
</html>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    function startPayment() {
        const amount = document.getElementById("amount").value;

        fetch(`/api/payments/create?amount=${amount}`, {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        })
        .then(response => response.json())
        .then(data => {
            const options = {
                key: data.key,
                amount: data.amount * 100,
                currency: data.currency,
                name: "Bank of Zulkar",
                description: "Deposit to your account",
                order_id: data.orderId,
                handler: function (response) {
                    // ‚úÖ This is the callback after successful payment
                    verifyPayment(response);
                },
                prefill: {
                    name: "Zulkar Alam",
                    email: "zulkar@example.com",
                    contact: "6204658549"
                },
                theme: {
                    color: "#3399cc"
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        });
    }

    function verifyPayment(response) {
        fetch("/api/payments/verify", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + localStorage.getItem("token")
            },
            body: JSON.stringify({
                orderId: response.razorpay_order_id,
                paymentId: response.razorpay_payment_id,
                signature: response.razorpay_signature
            })
        })
        .then(res => res.json())
        .then(data => {
            alert("‚úÖ Payment verified and account credited successfully!");
            console.log(data);
        })
        .catch(err => alert("‚ùå Payment verification failed"));
    }
</script>
